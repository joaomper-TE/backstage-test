apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: micro-frontend-multi-module-beta
  title: Multi Module Micro-Frontend Service Beta
  description: Create a Multi Module Micro-Frontend Service with Spring boot backend, Vue Frontend, and corresponding Deployment
  tags:
    - recommended
    - multi-module
    - java
    - spring-boot
    - vue
    - deployment
    - microfrontend
    - backend
    - frontend
spec:
  owner: engg-effectiveness@thousandeyes.com
  type: service
  parameters:
    - title: Microfrontend Multi-Module Project
      description: |
        This template will create an application matching the "application_name". Note that the corresponding image
        that gets generated by this codebase will also use "application_name", as will the deployment repository that
        gets created, and the sub-domain from which that your application will be served.
      required:
        - application_name
        - app_package_name
        - app_project_name
        - aws_auto_scaling_group
        - deployment_namespace
        - monitoring_id
        - owner
        - slack_notification_channel
      properties:
        application_name:
          title: Application Name
          type: string
          ui:description: |
            Name of the application. eg (notification-service). The deployment repo, service URL, and the docker image will
            all be derived from this name.  Important: only lowercase alphanumeric characters and dashes may be used.
        app_package_name:
          title: App Package Name
          type: string
          ui:description: |
            Will be used as the name for both frontend (Vue) and backend (Java) projects.
            Must be a valid Java package name (contains only alphanumeric characters and underscores).
        app_project_name:
          title: Application Project Name
          type: string
          ui:description: Name of the argo-deployment AppProject this app should be associated with (AppProject.metadata.name)
          enum:
            - agent-platform
            - ai
            - bbot
            - bgp
            - cloud-agents
            - cloud-and-enterprise-agents
            - cluster-services
            - cp
            - data-vis-platform
            - eb
            - gitops
            - infosec
            - integrations
            - internet-insights
            - observability
            - production-systems
            - revenue-platform
            - rum
            - ui-services
            - webapps
        description:
          title: Project Description
          type: string
          description: Brief description of the projects purpose.
        deployment_namespace:
          title: Deployment Namespace
          type: string
          ui:description: Kubernetes Namespace in which this application should be deployed
          enum:
            - accounting
            - agent
            - alerts
            - analytics
            - bbot
            - bgp
            - cloudagents
            - common
            - cp
            - csc
            - dash
            - dm
            - eb
            - exp
            - gitops
            - infosec
            - int
            - integrations
            - ops
            - rum
            - webapps
        monitoring_id:
          title: Prometheus Product ID
          type: string
          ui:description: ID used by observability tooling to configure metrics collection configuration
          enum:
            - act
            - agent
            - analytics
            - ai
            - bbot
            - bgp
            - ca
            - cicd
            - cp
            - dash
            - dm
            - eb
            - int
            - rum
            - webapps
        aws_auto_scaling_group:
          title: AWS Auto Scaling Group
          type: string
          ui:description: ASG of Nodes to which this applications resources will be assigned
          enum:
            - agent
            - alerts
            - bbot
            - bgp
            - cea
            - cp
            - dash
            - endpoint
            - engineering
            - engineering-effectiveness
            - integrations
            - internet
            - kube
            - ops
            - revenue
            - test
            - webapps
        owner:
          title: Owner
          type: string
          ui:description: Team ownership for this project.
          ui:field: OwnerPicker
          ui:options:
            allowedKinds:
              - Group
        slack_notification_channel:
          title: Slack Notification Channel
          type: string
          ui:description: Slack channel to set ArgoCD notifications to for this application
  steps:
    - id: context
      name: Load Scaffolder Context
      action: thousandeyes:context

    - id: argoDeployment
      name: Fetch argo-deployment
      action: fetch:plain
      input:
        url: https://github.com/${{steps.context.output.github_organization}}/argo-deployment
        targetPath: ./argo-deployment

    - id: templateApplication
      name: Fetch Application Skeleton + Template
      action: fetch:template
      input:
        url: ./application
        targetPath: ./application
        values:
          github_organization: ${{ steps.context.output.github_organization }}
          image_name: ${{ parameters.deployment_namespace }}/${{ parameters.application_name }}
          app_package_name: ${{ parameters.app_package_name }}
          owner: ${{ parameters.owner }}
          project_id: ${{ parameters.application_name }}
          project_description: ${{ parameters.description }}
          deployment_namespace: ${{ parameters.deployment_namespace }}

    - id: publishApplication
      name: Publish Application
      action: publish:github
      input:
        allowedHosts: ["github.com"]
        description: This is the ${{ parameters.application_name }} owned by ${{ parameters.owner }}
        repoUrl: github.com?repo=${{ parameters.application_name }}&owner=${{ steps.context.output.github_organization }}
        defaultBranch: main
        sourcePath: "/application"
        access: ${{ steps.context.output.github_organization }}/${{ parameters.owner }}   # org/team-name  e.g. thousandeyes/engineering-effectiveness
        collaborators:
          - team: engineering
            access: pull
          - team: automation
            access: admin
        topics:
          - engineering
          - jenkinsfile
          - application

    - id: jenkinsWebhookApplication
      name: Jenkins Webhook Application
      action: github:webhook
      input:
        webhookSecret: ${{ steps.context.output.jenkins_shared_secret }}
        webhookUrl: ${{ steps.context.output.jenkins_webhook_url }}
        contentType: json
        repoUrl: github.com?repo=${{ parameters.application_name }}&owner=${{ steps.context.output.github_organization }}
        events:
          - push
          - pull_request
          - repository

    - id: jarvisWebhookApplication
      name: Jarvis Webhook Application
      action: github:webhook
      input:
        webhookUrl: ${{ steps.context.output.jarvis_webhook_url }}
        contentType: json
        repoUrl: github.com?repo=${{ parameters.application_name }}&owner=${{ steps.context.output.github_organization }}
        events:
          - check_run
          - check_suite
          - create
          - commit_comment
          - delete
          - issue_comment
          - issues
          - label
          - pull_request
          - pull_request_review
          - pull_request_review_comment
          - push
          - release
          - repository
          - status

    - id: registerApplication
      name: Register Application
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps.publishApplication.output.repoContentsUrl }}
        catalogInfoPath: "/catalog-info.yaml"

    - id: editApplicationReadme
      name: Edit Application README
      action: thousandeyes:append-file
      input:
        filename: application/README.md
        contents: |

          Welcome to your first PR!

    - id: createApplicationPR
      name: Your First Application Pull Request
      action: publish:github:pull-request
      input:
        branchName: your-first-pr
        description: Adding README changes to trigger your initial build from the Portal
        repoUrl: github.com?repo=${{ parameters.application_name }}&owner=${{ steps.context.output.github_organization }}
        title: "[backstage] Updated README to trigger CI/CD workflow"
        sourcePath: ./application

    - id: templateDeployment
      name: Fetch Deployment Skeleton + Template
      action: fetch:template
      input:
        url: ./deployment
        targetPath: ./deployment
        values:
          application_name: ${{ parameters.application_name }}
          aws_auto_scaling_group: ${{ parameters.aws_auto_scaling_group }}
          deployment_namespace: ${{ parameters.deployment_namespace }}
          github_organization: ${{ steps.context.output.github_organization }}
          image_name: ${{ parameters.deployment_namespace }}/${{ parameters.application_name }}
          monitoring_id: ${{ parameters.monitoring_id }}
          owner: ${{ parameters.owner }}
          project_description: Deployment repo for the ${{ parameters.application_name }} app
          project_id: ${{ parameters.application_name }}-deployment

    - id: appSetTemplate
      name: Fetch ApplicationSet Template
      action: fetch:template
      input:
        url: https://github.com/${{steps.context.output.github_organization}}/backstage-software-templates/tree/main/shared-templates/skel-applicationSet
        targetPath: ./tmpl-appset
        values:
          application_name: ${{ parameters.application_name }}
          app_project_name: ${{parameters.app_project_name}}
          deployment_namespace: ${{ parameters.deployment_namespace }}
          github_organization: ${{ steps.context.output.github_organization }}
          image_name: ${{ parameters.deployment_namespace }}/${{ parameters.application_name }}
          owner: ${{ parameters.owner }}
          slack_notification_channel: ${{ parameters.slack_notification_channel }}

    - id: publishDeployment
      name: Publish Deployment
      action: publish:github
      input:
        allowedHosts: ["github.com"]
        description: This is the ${{ parameters.application_name }} deployment owned by ${{ parameters.owner }}
        repoUrl: github.com?repo=${{ parameters.application_name }}-deployment&owner=${{ steps.context.output.github_organization }}
        defaultBranch: main
        sourcePath: "/deployment"
        access: ${{ steps.context.output.github_organization }}/${{ parameters.owner }}   # org/team-name  e.g. thousandeyes/engineering-effectiveness
        collaborators:
          - team: engineering
            access: pull
          - team: automation
            access: admin
        topics:
          - engineering
          - jenkinsfile
          - deployment

    - id: jenkinsWebhookDeployment
      name: Jenkins Webhook Deployment
      action: github:webhook
      input:
        webhookSecret: ${{ steps.context.output.jenkins_shared_secret }}
        webhookUrl: ${{ steps.context.output.jenkins_webhook_url }}
        contentType: json
        repoUrl: github.com?repo=${{ parameters.application_name }}-deployment&owner=${{ steps.context.output.github_organization }}
        events:
          - push
          - pull_request
          - repository

    - id: jarvisWebhookDeployment
      name: Jarvis Webhook Deployment
      action: github:webhook
      input:
        webhookUrl: ${{ steps.context.output.jarvis_webhook_url }}
        contentType: json
        repoUrl: github.com?repo=${{ parameters.application_name }}-deployment&owner=${{ steps.context.output.github_organization }}
        events:
          - check_run
          - check_suite
          - create
          - commit_comment
          - delete
          - issue_comment
          - issues
          - label
          - pull_request
          - pull_request_review
          - pull_request_review_comment
          - push
          - release
          - repository
          - status

    - id: registerDeployment
      name: Register Deployment
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps.publishDeployment.output.repoContentsUrl }}
        catalogInfoPath: "/catalog-info.yaml"

    - id: registerAppSet
      name: Register AppSet in argo-deployment
      action: thousandeyes:add-applicationset
      input:
        appProjName: ${{ parameters.app_project_name }}
        appsetFilePath: ./tmpl-appset/${{ parameters.application_name }}.applicationset.yaml
        appDeployRepoURI: git@github.com:${{ steps.context.output.github_organization }}/${{ parameters.application_name }}-deployment.git

    - id: openArgoPullRequest
      name: Open argo-deployment Pull Request
      action: publish:github:pull-request
      input:
        repoUrl: github.com?repo=argo-deployment&owner=${{ steps.context.output.github_organization }}
        branchName: add-${{ parameters.application_name }}
        title: "[backstage] add ${{ parameters.application_name }} to staging argo-deployment"
        description: Adding ${{ parameters.application_name }} to staging argo-deployment from portal
        sourcePath: ${{ steps.registerAppSet.output.pullRequestDir }}

    - id: mergeArgoPullRequest
      name: Merge argo-deployment Pull Request
      action: github:actions:dispatch
      input:
        repoUrl: github.com?repo=argo-deployment&owner=${{ steps.context.output.github_organization }}
        workflowId: build-and-merge-backstage-PR.yaml
        branchOrTagName: add-${{ parameters.application_name }}

  output:
    links:
      - title: Open Application in Catalog
        icon: Catalog
        entityRef: ${{ steps.registerApplication.output.entityRef }}
      - title: Application Repository
        url: ${{ steps.publishApplication.output.remoteUrl }}
      - title: Open Deployment in Catalog
        icon: Catalog
        entityRef: ${{ steps.registerDeployment.output.entityRef }}
      - title: Deployment Repository
        url: ${{ steps.publishDeployment.output.remoteUrl }}
      - title: "argo-deployment Pull-Request #${{ steps.openArgoPullRequest.output.pullRequestNumber }}"
        url: ${{ steps.openArgoPullRequest.output.remoteUrl }}
